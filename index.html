<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Despensa 3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .card-shadow {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .shopping-mode-active {
            background-color: #fff7ed;
        }

        /* Remove setas do input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Animações */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        .badge-pulse {
            animation: pulse-yellow 2s infinite;
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(234, 179, 8, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
            }
        }

        /* Slider Customization */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #10b981;
            /* emerald-500 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            /* gray-200 */
            border-radius: 2px;
        }
    </style>
</head>

<body class="pb-28 transition-colors duration-300" id="main-body">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-md mx-auto px-4 pt-4 pb-2">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h1 class="text-xl font-bold text-gray-800" id="app-title">Minha Casa</h1>
                    <p class="text-xs text-gray-500" id="stats-display">Carregando...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleShoppingMode()" id="shop-btn"
                        class="p-2 rounded-full bg-gray-100 text-gray-600 transition hover:bg-orange-100 hover:text-orange-600 relative"
                        title="Modo Mercado">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                    </button>
                    <button onclick="toggleSettings()"
                        class="p-2 rounded-full bg-gray-100 text-gray-600 transition hover:bg-blue-100 hover:text-blue-600"
                        title="Configurações">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Settings Menu -->
            <div id="settings-panel"
                class="hidden bg-white border border-gray-200 rounded-xl p-4 mb-4 shadow-lg text-sm transition-all duration-200 ease-in-out">
                <p class="font-bold text-gray-700 mb-2">Backup de Dados</p>
                <div class="flex gap-2">
                    <button onclick="exportData()"
                        class="flex-1 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg font-medium hover:bg-blue-100 transition">⬇️
                        Baixar</button>
                    <button onclick="document.getElementById('file-input').click()"
                        class="flex-1 bg-green-50 text-green-700 px-3 py-2 rounded-lg font-medium hover:bg-green-100 transition">⬆️
                        Restaurar</button>
                    <input type="file" id="file-input" class="hidden" onchange="importData(this)">
                </div>
                <div class="mt-3 pt-3 border-t">
                    <p class="font-bold text-gray-700 mb-2">Categorias</p>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="new-cat-input" placeholder="Nova..."
                            class="flex-1 border rounded px-2 py-1 focus:ring-2 focus:ring-emerald-500 outline-none">
                        <button onclick="addCustomCategory()"
                            class="bg-gray-800 text-white px-3 py-1 rounded hover:bg-gray-700 transition">Add</button>
                    </div>
                    <div id="settings-cats-list" class="flex flex-wrap gap-2">
                        <!-- Categories injected here -->
                    </div>
                </div>
            </div>

            <!-- Search Bar Container -->
            <div class="relative" id="search-container">
                <input type="text" id="search-input" oninput="renderItems()" placeholder="Buscar item..."
                    class="w-full pl-9 pr-4 py-2.5 bg-gray-100 border-transparent focus:bg-white focus:ring-2 focus:ring-emerald-500 rounded-xl text-sm transition-all outline-none">
                <svg class="absolute left-3 top-3 text-gray-400" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>

            <div class="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1" id="category-filters"></div>
        </div>
    </header>

    <!-- Shopping Banner -->
    <div id="shopping-banner"
        class="hidden bg-orange-100 px-4 py-3 border-b border-orange-200 sticky top-[135px] z-10 shadow-sm flex flex-col gap-2 transition-all">
        <!-- Banner Content Dynamic -->
    </div>

    <main class="max-w-md mx-auto px-4 py-2" id="inventory-list"></main>

    <!-- FAB Add Button -->
    <button onclick="openAddModal()" id="add-btn"
        class="fixed bottom-6 right-6 bg-emerald-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-emerald-700 transition-transform active:scale-90 z-20 focus:outline-none focus:ring-4 focus:ring-emerald-300">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- Modal Form (Add/Edit) -->
    <div id="item-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center sm:px-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in transform transition-transform">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="modal-title">Novo Item</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>

            <form onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="edit-id">

                <div class="mb-4 relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label>

                    <div class="relative">
                        <input type="text" id="item-name" autocomplete="off" oninput="handleNameInput(this.value)"
                            list="suggestions" required
                            class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition-colors"
                            placeholder="Ex: Arroz, Leite..." autocomplete="off">
                        <div id="api-suggestions"
                            class="absolute left-0 right-0 top-full mt-1 bg-white rounded-xl shadow-xl border border-orange-100 hidden max-h-48 overflow-y-auto z-50">
                            <!-- API Results -->
                        </div>
                    </div>

                    <datalist id="suggestions"></datalist>
                </div>

                <!-- Nova Grid de 3 Colunas -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Qtd Atual</label>
                        <input type="number" id="item-qty" value="1" min="0" step="any" required
                            class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Unidade</label>
                        <select id="item-unit"
                            class="w-full px-2 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-colors appearance-none text-sm">
                            <option value="un">un</option>
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="L">L</option>
                            <option value="ml">ml</option>
                            <option value="pct">pct</option>
                            <option value="cx">cx</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-emerald-600 uppercase mb-1">Mínimo</label>
                        <input type="number" id="item-min" value="0" min="0" step="any"
                            class="w-full px-3 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-colors"
                            placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoria</label>
                        <select id="item-category"
                            class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-colors appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E')] bg-[length:12px_12px] bg-no-repeat bg-[right_1rem_center] text-sm"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Validade</label>
                        <input type="date" id="item-expiry"
                            class="w-full px-1 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-colors text-gray-600">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="button" id="btn-delete-item" onclick="deleteItem()"
                        class="hidden px-4 py-3 text-red-500 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition border border-red-100"
                        title="Excluir Item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg>
                    </button>
                    <button type="submit"
                        class="flex-1 py-3 text-white font-bold bg-emerald-600 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt/Review Modal -->
    <div id="receipt-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center sm:px-4 backdrop-blur-sm transition-opacity">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in transform transition-transform flex flex-col max-h-[85vh]">
            <h2 class="text-xl font-bold text-gray-800 mb-1">Revisar Compras</h2>
            <p class="text-xs text-gray-500 mb-4">Adicione o valor pago (opcional)</p>

            <div id="receipt-list" class="overflow-y-auto flex-1 pr-1 -mr-1 space-y-3 mb-4"></div>

            <div class="flex gap-2">
                <button onclick="closeReceiptModal()"
                    class="flex-1 py-3 text-gray-600 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition">Voltar</button>
                <button onclick="confirmReceipt()"
                    class="flex-1 py-3 text-white font-bold bg-orange-600 rounded-xl hover:bg-orange-700 shadow-lg shadow-orange-200 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center sm:px-4 backdrop-blur-sm transition-opacity">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in transform transition-transform flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Histórico</h2>
                    <p class="text-xs text-gray-500" id="hist-subtitle">Consumo do Item</p>
                </div>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="flex gap-2 mb-4">
                <div class="flex-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Início</label>
                    <input type="date" id="hist-start" onchange="renderHistoryList()"
                        class="w-full text-xs border rounded px-2 py-2 bg-gray-50 focus:ring-1 focus:ring-emerald-500 outline-none">
                </div>
                <div class="flex-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Fim</label>
                    <input type="date" id="hist-end" onchange="renderHistoryList()"
                        class="w-full text-xs border rounded px-2 py-2 bg-gray-50 focus:ring-1 focus:ring-emerald-500 outline-none">
                </div>
            </div>

            <div class="bg-emerald-50 p-3 rounded-lg mb-4 flex justify-between items-center border border-emerald-100">
                <div>
                    <span class="block text-xs text-emerald-800 mb-0.5">Total Consumido</span>
                    <span class="text-lg font-bold text-emerald-700 leading-none" id="hist-total-qty">0</span>
                </div>
                <div class="text-right">
                    <span class="block text-xs text-emerald-800 mb-0.5">Gasto Total</span>
                    <span class="text-lg font-bold text-emerald-700 leading-none" id="hist-total-spent">R$ 0,00</span>
                </div>
            </div>

            <div id="history-list" class="overflow-y-auto flex-1 pr-1 -mr-1 space-y-2 mb-4"></div>

            <button onclick="closeHistoryModal()"
                class="w-full py-3 text-gray-600 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition">Voltar</button>
        </div>
    </div>

    <!-- Inspect/Inventory Modal -->
    <div id="inspect-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center sm:px-4 backdrop-blur-sm transition-opacity">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in transform transition-transform flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-gray-800" id="inspect-title">Detalhes</h2>
                    <p class="text-xs text-gray-500" id="inspect-subtitle">Gerenciar Unidades</p>
                </div>
                <button onclick="closeInspectModal()" class="text-gray-400 hover:text-gray-600">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div id="batches-list" class="overflow-y-auto flex-1 pr-1 -mr-1 space-y-3 mb-4">
                <!-- Batches injected here -->
            </div>

            <div class="flex gap-2 flex-shrink-0">
                <button onclick="openHistory()"
                    class="flex-none p-3 text-gray-600 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition"
                    title="Histórico">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
                    </svg>
                </button>
                <button onclick="addNewBatch()"
                    class="flex-1 py-3 text-emerald-700 font-bold bg-emerald-50 rounded-xl hover:bg-emerald-100 border border-emerald-200 transition flex items-center justify-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Adicionar Unidade</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Toast -->
    <div id="toast"
        class="fixed top-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl text-sm font-medium opacity-0 transition-opacity z-50 pointer-events-none whitespace-nowrap">
    </div>

    <script>
        // ... (truncated previous scripts) ...

        // ... (truncated previous functions) ...

        // --- UI FUNCTIONS ---

        function deleteItem() {
            const id = document.getElementById('edit-id').value;
            if (!id) return;

            if (confirm("Tem certeza que deseja excluir este item e todo o seu histórico/estoque?")) {
                items = items.filter(i => i.id != id);
                shoppingCart.delete(parseFloat(id));
                shoppingChecked.delete(parseFloat(id));

                // Also clean up history for this item? 
                // Currently historyData stores itemId. Maybe keep it or ask user?
                // User said "remove item". Usually implies full removal.
                // Let's keep history for now or delete? 
                // Simpler to just delete from 'items'. History remains but 'orphan'.
                // Ideally we filter history too but maybe user wants records.
                // I will leave history intact for safety, but item is gone from list.

                save();
                renderItems();
                closeModal();
                showToast("Item excluído.");
            }
        }

        function openAddModal() {
            document.getElementById('modal-title').innerText = "Novo Item";
            document.getElementById('edit-id').value = "";
            document.getElementById('item-name').value = "";
            document.getElementById('item-qty').closest('div').classList.remove('invisible');
            document.getElementById('item-qty').value = "1";
            document.getElementById('item-min').value = "0";
            document.getElementById('item-unit').value = "un";
            document.getElementById('item-expiry').value = "";
            document.getElementById('btn-delete-item').classList.add('hidden'); // Hide delete
            document.getElementById('item-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('item-name').focus(), 100);
        }

        function openEditModal(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            document.getElementById('modal-title').innerText = "Editar Item";
            document.getElementById('edit-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            const qtyInput = document.getElementById('item-qty');
            qtyInput.value = getItemQty(item);
            qtyInput.closest('div').classList.add('invisible');
            document.getElementById('item-min').value = item.minQty || 0;
            document.getElementById('item-unit').value = item.unit || "un";
            document.getElementById('item-expiry').value = "";
            document.getElementById('item-category').value = item.category;
            document.getElementById('btn-delete-item').classList.remove('hidden'); // Show delete
            document.getElementById('item-modal').classList.remove('hidden');
        }
        // --- CONSTANTS & STATE ---
        const STORAGE_KEY_ITEMS = 'inventory_v3_data';
        const STORAGE_KEY_CATS = 'inventory_v3_cats';
        const STORAGE_KEY_HIST = 'inventory_v3_history'; // New Key

        const initialMockData = [
            { id: 1715620000001, name: "Leite Integral", batches: [{ id: 1, purchase: "", expiry: "", level: 100 }, { id: 2, purchase: "", expiry: "", level: 100 }], minQty: 3, unit: "L", category: "Geladeira" },
            { id: 1715620000002, name: "Arroz", batches: [{ id: 1, purchase: "", expiry: "", level: 100 }], minQty: 0, unit: "pct", category: "Despensa" },
            { id: 1715620000003, name: "Café", batches: [], minQty: 1, unit: "kg", category: "Despensa" }
        ];

        let items = JSON.parse(localStorage.getItem(STORAGE_KEY_ITEMS)) || initialMockData;
        let categories = JSON.parse(localStorage.getItem(STORAGE_KEY_CATS)) || ['Despensa', 'Geladeira', 'Limpeza', 'Higiene', 'Outros'];
        let historyData = JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)) || [];

        // ... (rest of vars)
        let activeCategory = 'Todos';
        let shoppingMode = false;
        let shoppingFilterSuggestions = false;
        let shoppingSelectionMode = false;

        let shoppingCart = new Map();
        let shoppingChecked = new Set();

        // ... (init function remains similar, but ensure to save history logic if needed, actually save() handles saving items)

        // We need a specific SaveHistory
        function saveHistory() {
            localStorage.setItem(STORAGE_KEY_HIST, JSON.stringify(historyData));
        }

        // ... (createBatch, save, getItemQty, etc.. remain same)

        // ... (inside removeBatch)
        function removeBatch(batchIdx) {
            const item = items.find(i => i.id === inspectingItemId);
            if (!item) return;

            if (confirm("Remover esta unidade? Ela será arquivada no histórico.")) {
                const batch = item.batches[batchIdx];

                // Archive logic
                historyData.push({
                    itemId: item.id,
                    itemName: item.name,
                    unit: item.unit,
                    category: item.category,
                    purchase: batch.purchase,
                    expiry: batch.expiry,
                    price: parseFloat(batch.price || 0),
                    consumedDate: new Date().toISOString().split('T')[0],
                    // We assume removing implies full consumption of whatever was left, 
                    // or just "removing from stock".
                    // Let's store "1 unit" count effectively.
                    originalBatchId: batch.id
                });

                item.batches.splice(batchIdx, 1);
                save();
                saveHistory();

                document.getElementById('inspect-subtitle').innerText = `${item.batches.length} Unidades • Total: ${getItemQty(item)} ${item.unit}`;
                renderBatchesList(item);
            }
        }

        // --- HISTORY VIEW LOGIC ---
        function openHistory() {
            const item = items.find(i => i.id === inspectingItemId);
            if (!item) return;

            document.getElementById('hist-subtitle').innerText = `Histórico: ${item.name}`;

            // Set default dates (Current Month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = today.toISOString().split('T')[0];

            document.getElementById('hist-start').value = firstDay;
            document.getElementById('hist-end').value = lastDay;

            renderHistoryList();
            document.getElementById('history-modal').classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        function renderHistoryList() {
            const startStr = document.getElementById('hist-start').value;
            const endStr = document.getElementById('hist-end').value;

            // Filter History for CURRENT ITEM and Date Range
            const relevant = historyData.filter(h => {
                return h.itemId === inspectingItemId &&
                    h.consumedDate >= startStr &&
                    h.consumedDate <= endStr;
            });

            // Sort by date desc
            relevant.sort((a, b) => b.consumedDate.localeCompare(a.consumedDate));

            const totalQty = relevant.length; // Assuming 1 batch = 1 unit mostly
            const totalSpent = relevant.reduce((acc, h) => acc + (h.price || 0), 0);

            document.getElementById('hist-total-qty').innerText = `${totalQty}`; // Unit will be beside
            document.getElementById('hist-total-spent').innerText = `R$ ${totalSpent.toFixed(2)}`;

            const list = document.getElementById('history-list');

            if (relevant.length === 0) {
                list.innerHTML = `<div class="text-center py-6 text-gray-400 text-xs">Nada encontrado no período.</div>`;
                return;
            }

            list.innerHTML = relevant.map(h => `
                <div class="bg-gray-50 p-2 rounded border border-gray-100 flex justify-between items-center text-xs">
                    <div>
                        <div class="font-bold text-gray-700">Consumido: ${h.consumedDate.split('-').reverse().join('/')}</div>
                        <div class="text-gray-400">Comprou: ${h.purchase ? h.purchase.split('-').reverse().join('/') : '-'}</div>
                    </div>
                    <div class="text-right">
                         <div class="font-bold text-gray-700">R$ ${h.price.toFixed(2)}</div>
                    </div>
                </div>
             `).join('');
        }

        // --- INIT & MIGRATION ---

        // --- API PRODUCT SEARCH ---
        let searchTimeout;

        async function handleNameInput(query) {
            const dropdown = document.getElementById('api-suggestions');
            if (!query || query.length < 3) {
                dropdown.classList.add('hidden');
                return;
            }

            // Clear existing timeout (Debounce 500ms)
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(async () => {
                dropdown.innerHTML = '<div class="p-3 text-xs text-center text-gray-400">Buscando...</div>';
                dropdown.classList.remove('hidden');

                try {
                    // Search Brazil OpenFoodFacts
                    const url = `https://br.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=5`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (data.products && data.products.length > 0) {
                        dropdown.innerHTML = data.products.map(p => {
                            const brand = p.brands ? p.brands.split(',')[0] : '';
                            const name = p.product_name || query;
                            const quantity = p.quantity || '';
                            const thumb = p.image_front_small_url || '';

                            // Encode object to pass to function
                            const productData = encodeURIComponent(JSON.stringify({
                                name: name,
                                brand: brand,
                                quantity: quantity,
                                unit: p.quantity,
                                image: p.image_front_small_url || "" // logic needed to parse
                            }));

                            return `
                            <div onclick="selectProductSuggestion('${productData}')" class="p-2 border-b last:border-0 hover:bg-orange-50 cursor-pointer flex items-center gap-3 transition">
                                ${thumb ? `<img src="${thumb}" class="w-8 h-8 object-contain rounded bg-white border border-gray-100">` : '<div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center text-gray-300">?</div>'}
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-sm text-gray-800 truncate">${name}</div>
                                    <div class="text-xs text-gray-500 truncate">${brand} ${quantity ? '• ' + quantity : ''}</div>
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        dropdown.innerHTML = '<div class="p-3 text-xs text-center text-gray-400">Nenhum produto encontrado.</div>';
                    }
                } catch (err) {
                    console.error(err);
                    dropdown.innerHTML = '<div class="p-3 text-xs text-center text-red-400">Erro na busca.</div>';
                }
            }, 600);
        }

        function selectProductSuggestion(jsonStr) {
            const product = JSON.parse(decodeURIComponent(jsonStr));

            const nameInput = document.getElementById('item-name');
            nameInput.value = product.brand ? `${product.name} - ${product.brand}` : product.name;

            document.getElementById('item-variant').value = product.name;
            document.getElementById('item-image').value = product.image || '';

            if (product.quantity) {
                const qtyStr = product.quantity.toLowerCase().replace(',', '.').trim();
                const match = qtyStr.match(/([\d\.]+)\s*([a-z]+)/);
                if (match) {
                    const val = parseFloat(match[1]);
                    let unit = match[2];

                    if (unit === 'g' || unit === 'gramas') {
                        if (val >= 1000) { document.getElementById('item-qty').value = val / 1000; unit = 'kg'; }
                        else { document.getElementById('item-qty').value = val; unit = 'g'; }
                    } else if (unit === 'ml') {
                        if (val >= 1000) { document.getElementById('item-qty').value = val / 1000; unit = 'L'; }
                        else { document.getElementById('item-qty').value = val; unit = 'ml'; }
                    } else {
                        document.getElementById('item-qty').value = val;
                    }

                    const validUnits = ['un', 'kg', 'g', 'L', 'ml', 'pct', 'cx'];
                    if (validUnits.includes(unit)) {
                        document.getElementById('item-unit').value = unit;
                    }
                }
            }
            document.getElementById('api-suggestions').classList.add('hidden');
        }

        // Hide dropdown on click outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('api-suggestions');
            const input = document.getElementById('item-name');
            if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        function init() {
            // Migration: Convert flat qty to batches
            items.forEach(item => {
                if (!item.batches) {
                    item.batches = [];
                    const scalarQty = item.qty || 0;

                    // Full units
                    for (let k = 0; k < Math.floor(scalarQty); k++) {
                        item.batches.push(createBatch(100, item.expiry || ""));
                    }
                    // Partial unit
                    const remainder = scalarQty % 1;
                    if (remainder > 0.001) {
                        item.batches.push(createBatch(Math.round(remainder * 100), item.expiry || ""));
                    }

                    delete item.qty; // cleanup old field
                }

                if (!item.unit) item.unit = 'un';
                if (item.minQty === undefined) item.minQty = 0;
            });

            if (!localStorage.getItem(STORAGE_KEY_ITEMS)) save();
            renderCategories();
            renderCategorySelect();
            updateSuggestions();
            renderItems();
            renderSettingsCategories();
            updateStats();
        }

        function createBatch(level = 100, expiry = "", purchase = "", price = "", variant = "", image = "") {
            return {
                id: Date.now() + Math.random(),
                level: level,
                expiry: expiry,
                purchase: purchase || new Date().toISOString().split('T')[0],
                price: price,
                variant: variant || "",
                image: image || ""
            };
        }

        function save() {
            localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
            localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(categories));
            updateSuggestions();
            updateStats();
        }

        // Helper: Get derived total qty from batches
        function getItemQty(item) {
            if (!item.batches || item.batches.length === 0) return 0;
            const sum = item.batches.reduce((acc, b) => acc + (b.level / 100), 0);
            return parseFloat(sum.toFixed(2));
        }

        // Helper: Get derived expiry status
        function getExpiryDate(item) {
            const activeBatches = item.batches.filter(b => b.level > 0 && b.expiry);
            if (activeBatches.length === 0) return null;
            // Sort by date strings
            activeBatches.sort((a, b) => a.expiry.localeCompare(b.expiry));
            return activeBatches[0].expiry;
        }

        // Helper para evitar erros de ponto flutuante
        function safeMath(val) {
            return parseFloat(val.toFixed(3));
        }

        // --- CORE LOGIC ---

        function handleFormSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const name = document.getElementById('item-name').value.trim();
            // Note: Qty in main form is now mostly for initial setup or ignored in edits
            const minQty = parseFloat(document.getElementById('item-min').value) || 0;
            const unit = document.getElementById('item-unit').value;
            const category = document.getElementById('item-category').value;
            // Expiry field in main modal is deprecated for batches, but we keep it for "first batch" creation if new

            if (!name) return;

            if (editId) {
                const item = items.find(i => i.id == editId);
                if (item) {
                    item.name = name;
                    item.minQty = safeMath(minQty);
                    item.unit = unit;
                    item.category = category;
                    showToast('Item atualizado!');
                }
            } else {
                const existing = items.find(i => i.name.toLowerCase() === name.toLowerCase());
                if (existing) {
                    if (confirm(`${name} já existe. Atualizar dados?`)) {
                        existing.minQty = safeMath(minQty);
                        existing.category = category;
                        existing.unit = unit;
                        showToast(`Atualizado!`);
                    }
                } else {
                    // Create new item with 1 batch
                    const firstQty = parseFloat(document.getElementById('item-qty').value) || 0;
                    const firstExpiry = document.getElementById('item-expiry').value;
                    const variantVal = document.getElementById('item-variant') ? document.getElementById('item-variant').value : '';
                    const imageVal = document.getElementById('item-image') ? document.getElementById('item-image').value : '';

                    const newBatches = [];
                    // Full units
                    for (let k = 0; k < Math.floor(firstQty); k++) {
                        newBatches.push(createBatch(100, firstExpiry, "", "", variantVal, imageVal));
                    }
                    // Partial
                    const rem = firstQty % 1;
                    if (rem > 0.001) {
                        newBatches.push(createBatch(Math.round(rem * 100), firstExpiry, "", "", variantVal, imageVal));
                    }


                    items.unshift({
                        id: Date.now(),
                        name: name.charAt(0).toUpperCase() + name.slice(1),
                        batches: newBatches,
                        minQty: safeMath(minQty),
                        unit, category
                    });
                    showToast('Item adicionado!');
                }
            }

            save();
            closeModal();
            renderItems();
        }

        // --- BATCH INSPECTION LOGIC ---
        let inspectingItemId = null;

        function checkInspectItem(id) {
            inspectItem(id);
        }

        function inspectItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            inspectingItemId = id;
            document.getElementById('inspect-title').innerText = item.name;
            document.getElementById('inspect-subtitle').innerText = `${item.batches.length} Unidades • Total: ${getItemQty(item)} ${item.unit}`;

            renderBatchesList(item);
            document.getElementById('inspect-modal').classList.remove('hidden');
        }

        function closeInspectModal() {
            document.getElementById('inspect-modal').classList.add('hidden');
            inspectingItemId = null;
            renderItems(); // Refresh main list to show updated scalar qty
        }

        function formatDateShort(iso) {
            if (!iso) return '-';
            const [y, m, d] = iso.split('-');
            return `${d}/${m}/${y.slice(-2)}`;
        }


        // --- BATCH VARIANT SEARCH (INSPECTOR) ---
        let batchSearchTimeout;

        function toggleBatchSearch(idx) {
            const container = document.getElementById(`batch-search-container-${idx}`);
            // Toggle visibility
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                document.getElementById(`batch-search-input-${idx}`).focus();
            }
        }

        async function handleBatchSearch(idx, query) {
            const resultsDiv = document.getElementById(`batch-search-results-${idx}`);
            if (!query || query.length < 3) {
                resultsDiv.innerHTML = '';
                return;
            }

            clearTimeout(batchSearchTimeout);
            batchSearchTimeout = setTimeout(async () => {
                resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-gray-400">Buscando...</div>';

                try {
                    const url = `https://br.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=5`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (data.products && data.products.length > 0) {
                        resultsDiv.innerHTML = data.products.map(p => {
                            const brand = p.brands ? p.brands.split(',')[0] : '';
                            const name = p.product_name || query;
                            const image = p.image_front_small_url || '';

                            const productData = encodeURIComponent(JSON.stringify({
                                name: name,
                                brand: brand,
                                image: image
                            }));

                            return `
                            <div onclick="selectBatchVariant(${idx}, '${productData}')" class="p-2 border-b last:border-0 hover:bg-orange-50 cursor-pointer flex items-center gap-2 transition">
                                ${image ? `<img src="${image}" class="w-6 h-6 object-contain rounded bg-white">` : '<div class="w-6 h-6 bg-gray-100 rounded"></div>'}
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-[10px] text-gray-800 truncate">${name}</div>
                                    <div class="text-[9px] text-gray-500 truncate">${brand}</div>
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-gray-400">Nada encontrado.</div>';
                    }
                } catch (err) {
                    console.error(err);
                    resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-red-400">Erro.</div>';
                }
            }, 600);
        }

        function selectBatchVariant(idx, jsonStr) {
            const product = JSON.parse(decodeURIComponent(jsonStr));
            const item = items.find(i => i.id === inspectingItemId);
            if (!item || !item.batches[idx]) return;

            // Update Batch Data
            item.batches[idx].variant = product.name;
            item.batches[idx].image = product.image || '';

            save();
            renderBatchesList(item); // Re-render to show changes
        }

        function renderBatchesList(item) {
            const container = document.getElementById('batches-list');

            if (item.batches.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">Nenhuma unidade em estoque.</div>`;
                return;
            }

            container.innerHTML = item.batches.map((batch, idx) => `
        <div class="bg-gray-50 p-2 rounded-xl border border-gray-200 mb-2 relative group overflow-visible">
            <!-- Row Content -->
            <div class="flex gap-3">
                <!-- Image Column (Larger) -->
                <div class="w-20 h-20 bg-white rounded-lg border border-gray-200 flex items-center justify-center flex-shrink-0 overflow-hidden relative mt-1">
                    ${batch.image ? `<img src="${batch.image}" class="w-full h-full object-contain">` : '<span class="text-gray-300 text-[10px]">Foto</span>'}
                </div>
                
                <!-- Details Column -->
                <div class="flex-1 min-w-0 flex flex-col justify-between py-0.5 relative">
                    <!-- Variant Name Header (Clickable) -->
                    <div class="flex justify-between items-start mb-1.5">
                        <div onclick="toggleBatchSearch(${idx})" 
                             class="text-xs font-bold text-gray-800 truncate pr-2 uppercase tracking-tight leading-snug cursor-pointer hover:text-emerald-600 transition decoration-dotted underline underline-offset-2 decoration-gray-300">
                            ${batch.variant || 'Unidade Padrão'} <span class="text-[9px] text-emerald-500 font-normal ml-1">✎</span>
                        </div>
                        <button onclick="removeBatch(${idx})" class="text-gray-400 hover:text-red-500 transition -mt-1 -mr-1 p-1">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>

                    <!-- Search Dropdown (Absolute overlay) -->
                    <div id="batch-search-container-${idx}" class="hidden absolute top-6 left-0 w-full bg-white rounded-lg border border-orange-200 shadow-lg z-20">
                        <input type="text" id="batch-search-input-${idx}" 
                            placeholder="Buscar ex: Ninho Integral..." 
                            class="w-full text-[10px] p-2 outline-none border-b border-gray-100 bg-orange-50/30"
                            oninput="handleBatchSearch(${idx}, this.value)">
                        <div id="batch-search-results-${idx}" class="max-h-32 overflow-y-auto bg-white rounded-b-lg"></div>
                    </div>

                    <!-- Dates & Price Row -->
                    <div class="flex gap-2 mb-1.5">
                        <div class="w-16">
                            <label class="text-[8px] uppercase font-bold text-gray-400 block mb-0.5 text-center">Comprou</label>
                            <div class="relative w-full h-6 bg-white border border-gray-200 rounded flex items-center justify-center">
                                <span class="text-[9px] text-gray-600 font-medium">${formatDateShort(batch.purchase)}</span>
                                <input type="date" value="${batch.purchase}" 
                                    onchange="updateBatch(${idx}, 'purchase', this.value); this.previousElementSibling.innerText = formatDateShort(this.value)" 
                                    class="absolute inset-0 opacity-0 w-full h-full z-10 cursor-pointer">
                            </div>
                        </div>
                        <div class="w-16">
                            <label class="text-[8px] uppercase font-bold text-gray-400 block mb-0.5 text-center">Vence</label>
                            <div class="relative w-full h-6 bg-white border border-gray-200 rounded flex items-center justify-center">
                                <span class="text-[9px] text-gray-600 font-medium">${formatDateShort(batch.expiry)}</span>
                                <input type="date" value="${batch.expiry}" 
                                    onchange="updateBatch(${idx}, 'expiry', this.value); this.previousElementSibling.innerText = formatDateShort(this.value)" 
                                    class="absolute inset-0 opacity-0 w-full h-full z-10 cursor-pointer">
                            </div>
                        </div>
                        <div class="w-16">
                            <label class="text-[8px] uppercase font-bold text-gray-400 block mb-0.5 text-center">Valor</label>
                            <div class="w-full h-6 bg-white border border-gray-200 rounded flex items-center px-1">
                                <span class="text-[9px] text-gray-400 mr-1">R$</span>
                                <input type="tel" placeholder="0.00" value="${batch.price ? parseFloat(batch.price).toFixed(2) : ''}"
                                oninput="handleCurrencyInput(event)"
                                onchange="updateBatch(${idx}, 'price', this.value)"
                                class="flex-1 bg-transparent border-none p-0 text-[9px] text-gray-600 focus:ring-0 w-full h-full leading-none outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Level Slider -->
                    <div class="flex items-center gap-2">
                        <input type="range" min="0" max="100" value="${batch.level}"
                            oninput="updateBatch(${idx}, 'level', this.value)"
                            class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                        <span class="font-bold text-[10px] w-8 text-right batch-level-text ${batch.level < 20 ? 'text-red-500' : 'text-emerald-700'}">${batch.level}%</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
        }


        // --- CURRENCY HANDLING ---
        function handleCurrencyInput(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val === '') {
                e.target.value = '';
                return;
            }
            val = parseInt(val, 10);
            e.target.value = (val / 100).toFixed(2);
        }

        function updateBatch(batchIdx, field, value) {
            const item = items.find(i => i.id === inspectingItemId);
            if (!item) return;

            const batch = item.batches[batchIdx];
            if (field === 'level') batch.level = parseInt(value);
            else batch[field] = value;

            save();
            // Re-render header stats only, to avoid input jumping
            document.getElementById('inspect-subtitle').innerText = `${item.batches.length} Unidades • Total: ${getItemQty(item)} ${item.unit}`;

            // Color update for text
            const levelText = document.querySelectorAll('#batches-list .batch-level-text')[batchIdx];
            if (levelText) {
                levelText.innerText = `${batch.level}%`;
                levelText.className = `font-bold batch-level-text ${batch.level < 20 ? 'text-red-500' : 'text-emerald-700'}`;
            }
        }

        function addNewBatch() {
            const item = items.find(i => i.id === inspectingItemId);
            if (!item) return;

            item.batches.push(createBatch(100)); // New full unit
            save();
            document.getElementById('inspect-subtitle').innerText = `${item.batches.length} Unidades • Total: ${getItemQty(item)} ${item.unit}`;
            renderBatchesList(item);
        }

        function removeBatch(batchIdx) {
            const item = items.find(i => i.id === inspectingItemId);
            if (!item) return;

            if (confirm("Remover esta unidade? Ela será arquivada no histórico.")) {
                const batch = item.batches[batchIdx];

                // Archive logic
                historyData.push({
                    itemId: item.id,
                    itemName: item.name,
                    unit: item.unit,
                    category: item.category,
                    purchase: batch.purchase,
                    expiry: batch.expiry,
                    price: parseFloat(batch.price || 0),
                    consumedDate: new Date().toISOString().split('T')[0],
                    originalBatchId: batch.id
                });

                item.batches.splice(batchIdx, 1);
                save();
                saveHistory();

                document.getElementById('inspect-subtitle').innerText = `${item.batches.length} Unidades • Total: ${getItemQty(item)} ${item.unit}`;
                renderBatchesList(item);
            }
        }



        // --- SHOPPING CART LOGIC ---

        function toggleCartItem(id) {
            // If in Cart View, toggle Check status
            if (shoppingMode && !shoppingSelectionMode) {
                if (shoppingChecked.has(id)) {
                    shoppingChecked.delete(id);
                } else {
                    shoppingChecked.add(id);
                }
            } else {
                // In Selection View, toggle List presence
                if (shoppingCart.has(id)) {
                    shoppingCart.delete(id);
                    shoppingChecked.delete(id);
                } else {
                    shoppingCart.set(id, 1);
                }
            }
            renderItems();
        }

        function removeFromCart(id) {
            shoppingCart.delete(id);
            shoppingChecked.delete(id);
            renderItems();
        }

        function setCartQty(id, valStr) {
            const val = parseFloat(valStr);
            if (val >= 0) {
                shoppingCart.set(id, safeMath(val));
            } else {
                shoppingCart.set(id, 0);
            }
        }

        function updateCartQtyBtn(id, change) {
            const current = shoppingCart.get(id) || 1;
            const newVal = safeMath(current + change);
            if (newVal > 0) {
                shoppingCart.set(id, newVal);
                renderItems();
            }
        }

        function finishShopping() {
            if (shoppingChecked.size === 0) {
                showToast("Marque os itens comprados.");
                return;
            }

            // Open Receipt Modal
            renderReceiptList();
            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        function closeReceiptModal() {
            document.getElementById('receipt-modal').classList.add('hidden');
        }

        function renderReceiptList() {
            const list = document.getElementById('receipt-list');
            let html = '';

            shoppingChecked.forEach(id => {
                const item = items.find(i => i.id === id);
                if (!item) return;

                const boughtQty = shoppingCart.get(id) || 1;
                // Try to find previous batch price/info for defaults
                const lastBatch = item.batches && item.batches.length > 0 ? item.batches[item.batches.length - 1] : null;
                const defaultPrice = lastBatch && lastBatch.price ? parseFloat(lastBatch.price).toFixed(2) : '';

                html += `
        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-2 relative group">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    <!-- Variant Image (if set from previous purchases?) or item default? For now Item doesn't have image, only batches. -->
                    <h3 class="font-bold text-gray-700">${item.name}</h3>
                    <span class="text-xs text-gray-400 bg-white px-1.5 py-0.5 rounded border border-gray-100">${item.category}</span>
                </div>
                <div class="flex flex-col items-end">
                     <span class="text-[10px] text-gray-400 mb-0.5">Preço Unit.</span>
                     <input type="tel" placeholder="0.00" 
                        id="receipt-price-${id}"
                        value="${defaultPrice}"
                        oninput="handleCurrencyInput(event)"
                        class="w-24 text-right bg-white border text-sm px-2 py-1.5 rounded text-gray-700 focus:ring-1 focus:ring-emerald-500 outline-none font-medium">
                </div>
            </div>

            <!-- Variant Selection Row -->
            <div class="flex items-center gap-2 mt-2">
                <!-- Visual / Trigger -->
                <div class="flex-1 bg-white border border-gray-200 rounded-lg p-1.5 flex items-center gap-2 cursor-pointer hover:border-emerald-300 transition h-12"
                        onclick="toggleReceiptSearch(${id})">
                        
                        <div id="receipt-variant-visual-${id}" class="flex items-center gap-2 flex-1 min-w-0">
                        <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-300">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        </div>
                        <span class="text-xs text-gray-400">Qual marca/tipo você comprou?</span>
                        </div>
                        
                        <div class="text-gray-300">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                </div>

                <!-- Hidden Inputs -->
                <input type="hidden" id="receipt-variant-name-${id}" value="">
                <input type="hidden" id="receipt-variant-image-${id}" value="">
            </div>

            <!-- Dropdown Search (Initially Hidden) -->
            <div id="receipt-search-container-${id}" class="hidden mt-2 bg-white rounded-lg border border-orange-100 shadow-sm overflow-hidden z-20 relative">
                <input type="text" id="receipt-search-input-${id}" 
                    placeholder="Busque ex: Leite Integral Italac..." 
                    class="w-full text-xs p-2 outline-none border-b border-gray-50 bg-gray-50"
                    oninput="handleReceiptSearch(${id}, this.value)">
                <div id="receipt-search-results-${id}" class="max-h-32 overflow-y-auto">
                    <!-- Results -->
                </div>
            </div>

        </div>
        `;
            });
            list.innerHTML = html;
        }


        // --- RECEIPT VARIANT SEARCH ---
        let receiptSearchTimeout;

        function toggleReceiptSearch(id) {
            const container = document.getElementById(`receipt-search-container-${id}`);
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                document.getElementById(`receipt-search-input-${id}`).focus();
            }
        }

        async function handleReceiptSearch(id, query) {
            const resultsDiv = document.getElementById(`receipt-search-results-${id}`);
            if (!query || query.length < 3) {
                resultsDiv.innerHTML = '';
                return;
            }

            clearTimeout(receiptSearchTimeout);
            receiptSearchTimeout = setTimeout(async () => {
                resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-gray-400">Buscando...</div>';

                try {
                    const url = `https://br.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=5`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (data.products && data.products.length > 0) {
                        resultsDiv.innerHTML = data.products.map(p => {
                            const brand = p.brands ? p.brands.split(',')[0] : '';
                            const name = p.product_name || query;
                            const image = p.image_front_small_url || '';

                            const productData = encodeURIComponent(JSON.stringify({
                                name: name,
                                brand: brand,
                                image: image
                            }));

                            return `
                            <div onclick="selectReceiptProduct(${id}, '${productData}')" class="p-2 border-b last:border-0 hover:bg-orange-50 cursor-pointer flex items-center gap-2 transition">
                                ${image ? `<img src="${image}" class="w-6 h-6 object-contain rounded bg-white">` : '<div class="w-6 h-6 bg-gray-100 rounded"></div>'}
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-[10px] text-gray-800 truncate">${name}</div>
                                    <div class="text-[9px] text-gray-500 truncate">${brand}</div>
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-gray-400">Nada encontrado.</div>';
                    }
                } catch (err) {
                    console.error(err);
                    resultsDiv.innerHTML = '<div class="p-2 text-xs text-center text-red-400">Erro.</div>';
                }
            }, 600);
        }

        function selectReceiptProduct(id, jsonStr) {
            const product = JSON.parse(decodeURIComponent(jsonStr));

            // Update UI
            document.getElementById(`receipt-variant-name-${id}`).value = product.name + (product.brand ? ' - ' + product.brand : '');
            document.getElementById(`receipt-variant-image-${id}`).value = product.image || '';

            // Show selection visual
            const visual = document.getElementById(`receipt-variant-visual-${id}`);
            visual.innerHTML = `
                ${product.image ? `<img src="${product.image}" class="w-8 h-8 object-contain rounded bg-white border border-gray-100">` : ''}
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-emerald-700 truncate leading-tight">${product.name}</div>
                    <div class="text-[9px] text-gray-500 truncate">${product.brand}</div>
                </div>
            `;

            // Hide Search
            document.getElementById(`receipt-search-container-${id}`).classList.add('hidden');
        }

        function confirmReceipt() {
            let count = 0;
            shoppingChecked.forEach(id => {
                const checkedQty = shoppingCart.get(id) || 1;
                const item = items.find(i => i.id === id);
                if (item) {

                    const priceInput = document.getElementById(`receipt-price-${id}`).value;
                    const variantInput = document.getElementById(`receipt-variant-name-${id}`).value;
                    const imageInput = document.getElementById(`receipt-variant-image-${id}`).value;

                    // Add N batches
                    const fullUnits = Math.floor(checkedQty);
                    const remainder = checkedQty % 1;

                    for (let k = 0; k < fullUnits; k++) {
                        item.batches.push(createBatch(100, "", "", priceInput, variantInput, imageInput));
                    }
                    if (remainder > 0.001) {
                        item.batches.push(createBatch(Math.round(remainder * 100), "", "", priceInput, variantInput, imageInput));
                    }

                    count++;
                }
            });

            // Clear checked items from cart. Keep unchecked?
            // "Apple Reminders" style: things not done stay in list.
            shoppingChecked.forEach(id => shoppingCart.delete(id));
            shoppingChecked.clear();

            closeReceiptModal();
            // Stay in shopping mode? Or Toggle? User said "mark as completed in real life".
            // Usually we stay in mode.
            save();
            renderItems();
            showToast(`${count} itens concluídos!`);
        }



        function closeModal() {
            document.getElementById('item-modal').classList.add('hidden');
            document.getElementById('item-qty').closest('div').classList.remove('invisible');
        }

        function toggleShoppingMode() {
            shoppingMode = !shoppingMode;
            shoppingSelectionMode = false; // Start in Cart View
            shoppingFilterSuggestions = false;

            const body = document.getElementById('main-body');
            const banner = document.getElementById('shopping-banner');
            const addBtn = document.getElementById('add-btn');
            const shopBtn = document.getElementById('shop-btn');

            if (shoppingMode) {
                body.classList.add('shopping-mode-active');
                banner.classList.remove('hidden');
                addBtn.classList.add('hidden');
                activeCategory = 'Todos';
                shopBtn.classList.add('bg-orange-100', 'text-orange-600');
                showToast("Modo Mercado Ativado");
            } else {
                body.classList.remove('shopping-mode-active');
                banner.classList.add('hidden');
                addBtn.classList.remove('hidden');
                shopBtn.classList.remove('bg-orange-100', 'text-orange-600');
                // Don't clear cart on exit, persist list? 
                // For now clear to keep state simple slightly? 
                // User said "open empty list". Maybe persistent list is better?
                // Let's keep it persistent during session, but maybe clearing on explicit Toggle is OK.
                // Or better: clear cart only if CONFIRMED receipt.
                // Let's NOT clear here to allow "Closing app and coming back".
                // But current persistence is only memory (Map).
                // TODO: Persist Cart to LocalStorage? (Out of scope but good).
            }
            renderShoppingBanner();
            renderCategories();
            renderItems();
        }

        function toggleShoppingSelection() {
            shoppingSelectionMode = !shoppingSelectionMode;
            renderShoppingBanner();
            renderCategories();
            renderItems();
        }

        function toggleShoppingFilter() {
            shoppingFilterSuggestions = !shoppingFilterSuggestions;
            renderShoppingBanner();
            renderItems();
        }

        function renderShoppingBanner() {
            const banner = document.getElementById('shopping-banner');
            const searchContainer = document.getElementById('search-container');
            const catFilters = document.getElementById('category-filters');

            if (!shoppingMode) return;

            if (shoppingSelectionMode) {
                if (searchContainer) searchContainer.style.display = 'block';
                if (catFilters) catFilters.style.display = 'flex';

                banner.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-orange-900">Adicionar Produtos</span>
                        <button onclick="toggleShoppingSelection()" class="text-xs bg-orange-600 text-white font-bold px-3 py-1.5 rounded-lg shadow hover:bg-orange-700 transition">
                            Concluir Seleção
                        </button>
                    </div>
                    <div class="flex items-center justify-between bg-white/40 rounded-lg p-1">
                        <span class="text-xs font-bold text-orange-800 ml-2">Apenas Sugestões</span>
                        <button onclick="toggleShoppingFilter()" class="w-10 h-5 ${shoppingFilterSuggestions ? 'bg-orange-500' : 'bg-gray-300'} rounded-full relative transition-colors duration-200">
                            <div class="bg-white w-4 h-4 rounded-full absolute top-0.5 left-0.5 shadow-sm transition-transform duration-200 ${shoppingFilterSuggestions ? 'translate-x-5' : 'translate-x-0'}"></div>
                        </button>
                    </div>
                 `;
            } else {
                if (searchContainer) searchContainer.style.display = 'none';
                if (catFilters) catFilters.style.display = 'none';

                const count = shoppingCart.size;
                const checked = shoppingChecked.size;

                banner.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                             <span class="text-sm font-bold text-orange-900 block">Lista de Compras</span>
                             <span class="text-xs text-orange-700">${checked}/${count} comprados</span>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="toggleShoppingSelection()" class="text-xs bg-white text-orange-800 font-bold px-3 py-1.5 rounded-lg border border-orange-200 hover:bg-orange-50 transition flex items-center gap-1">
                                <span>+ Catálogo</span>
                             </button>
                             <button onclick="toggleShoppingMode()" class="text-xs bg-transparent text-orange-900/60 px-2 py-1 hover:text-orange-900">Sair</button>
                        </div>
                    </div>
                 `;
            }
        }

        // --- RENDER ---

        // Helper for Cart Row
        function renderCartItemRow(item, isChecked) {
            const buyQty = shoppingCart.get(item.id) || 1;
            const unit = item.unit || 'un';
            const qty = getItemQty(item);

            const bgClass = isChecked ? 'bg-gray-100 border-gray-200' : 'bg-white border-orange-200';
            const textClass = isChecked ? 'text-gray-400 line-through' : 'text-gray-800';
            const checkColor = isChecked ? 'bg-orange-500 border-orange-500 text-white' : 'border-gray-400 bg-white';

            return `
             <div class="p-3 rounded-xl mb-2 border ${bgClass} transition-all animate-fade-in relative group">
                <div class="flex items-center justify-between">
                    <div onclick="toggleCartItem(${item.id})" class="flex items-center gap-3 cursor-pointer flex-1">
                        <div class="w-6 h-6 rounded-full border-2 ${checkColor} flex items-center justify-center transition-all">
                             ${isChecked ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}
                        </div>
                        <div>
                            <div class="flex items-center">
                                <span class="font-bold text-lg block ${textClass}">${item.name}</span>
                            </div>
                            <span class="text-xs text-gray-400">Estoque: ${qty} ${unit}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1" onclick="event.stopPropagation()">
                         <div class="flex items-center bg-white/50 rounded-lg border border-gray-200 shadow-sm h-8">
                            <button onclick="updateCartQtyBtn(${item.id}, -1)" class="w-8 h-full flex items-center justify-center text-orange-600 font-bold hover:bg-orange-50 rounded-l">-</button>
                            <input type="number" value="${buyQty}" onchange="setCartQty(${item.id}, this.value)" class="w-12 h-full text-center text-sm font-bold bg-transparent outline-none">
                            <button onclick="updateCartQtyBtn(${item.id}, 1)" class="w-8 h-full flex items-center justify-center text-orange-600 font-bold hover:bg-orange-50 rounded-r">+</button>
                        </div>
                        <button onclick="removeFromCart(${item.id})" class="text-gray-300 hover:text-red-500 p-2">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
             </div>
             `;
        }

        // Quick Add Logic
        let quickSearchTimeout;
        function handleQuickAddSearch(query) {
            // Logic to show dropdown
            const dropdown = document.getElementById('quick-add-dropdown');
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            const matches = items.filter(i =>
                !shoppingCart.has(i.id) &&
                i.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);

            if (matches.length === 0) {
                dropdown.innerHTML = `<div class="p-3 text-xs text-gray-400 text-center">Nenhum item encontrado.<br>Use "Novo Item" para criar.</div>`;
            } else {
                dropdown.innerHTML = matches.map(i => `
                    <div onclick="quickAddExisiting(${i.id})" class="p-3 border-b last:border-0 hover:bg-orange-50 cursor-pointer flex justify-between items-center bg-white text-gray-700">
                        <span class="font-bold">${i.name}</span>
                        <span class="text-xs text-gray-400">${getItemQty(i)} ${i.unit}</span>
                    </div>
                 `).join('');
            }
            dropdown.classList.remove('hidden');
        }

        function quickAddExisiting(id) {
            shoppingCart.set(id, 1);
            document.getElementById('quick-add-dropdown').classList.add('hidden');
            const input = document.getElementById('quick-add-input');
            if (input) input.value = '';
            renderItems();
        }

        function renderItems() {
            const list = document.getElementById('inventory-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const today = new Date().toISOString().split('T')[0];
            const warningStr = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];

            let filtered = items;

            // --- FILTERING ---

            if (shoppingMode && shoppingSelectionMode) {
                filtered = items.filter(i => i.name.toLowerCase().includes(search));
                if (shoppingFilterSuggestions) {
                    filtered = filtered.filter(i => {
                        const qty = getItemQty(i);
                        return qty === 0 || (i.minQty > 0 && qty <= i.minQty);
                    });
                }
                if (activeCategory !== 'Todos' && activeCategory !== 'Faltando') {
                    filtered = filtered.filter(i => i.category === activeCategory);
                }
            } else if (!shoppingMode) {
                filtered = items.filter(i => i.name.toLowerCase().includes(search));
                if (activeCategory === 'Faltando') {
                    filtered = filtered.filter(i => {
                        const qty = getItemQty(i);
                        return qty === 0 || (i.minQty > 0 && qty <= i.minQty);
                    });
                } else if (activeCategory !== 'Todos') {
                    filtered = filtered.filter(i => i.category === activeCategory);
                }
            }
            // In Cart View (!selection), we use 'filtered' as 'items' mostly, 
            // but we filter manually in the view block below.

            // --- SORTING ---
            if (!shoppingMode) {
                filtered.sort((a, b) => {
                    const qtyA = getItemQty(a);
                    const qtyB = getItemQty(b);
                    const expiryA = getExpiryDate(a);
                    const expiryB = getExpiryDate(b);

                    const aIsLow = a.minQty > 0 && qtyA <= a.minQty;
                    const bIsLow = b.minQty > 0 && qtyB <= b.minQty;

                    if (qtyA === 0 && qtyB !== 0) return -1;
                    if (qtyA !== 0 && qtyB === 0) return 1;
                    if (aIsLow && !bIsLow) return -1;
                    if (!aIsLow && bIsLow) return 1;
                    if (expiryA && (!expiryB)) return -1;
                    if (!expiryA && expiryB) return 1;
                    if (expiryA && expiryB && expiryA < warningStr && expiryB >= warningStr) return -1;

                    return a.name.localeCompare(b.name);
                });
            }

            // --- VIEW RENDER ---

            if (shoppingMode && !shoppingSelectionMode) {
                // CART VIEW
                const cartCount = shoppingCart.size;
                const checkedCount = shoppingChecked.size;

                // List Items
                const pendingItems = items.filter(i => shoppingCart.has(i.id) && !shoppingChecked.has(i.id));
                const doneItems = items.filter(i => shoppingCart.has(i.id) && shoppingChecked.has(i.id));

                pendingItems.sort((a, b) => a.name.localeCompare(b.name));
                doneItems.sort((a, b) => a.name.localeCompare(b.name));

                const buttonHtml = checkedCount > 0
                    ? `<button onclick="finishShopping()" class="w-full bg-orange-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-orange-700 transition flex items-center justify-center gap-2 animate-bounce-short">
                         <span>Concluir (${checkedCount})</span>
                       </button>`
                    : `<div class="text-xs text-orange-800 text-center py-2 opacity-50">Marque itens para concluir</div>`;

                let html = `
                    <div class="mb-4 sticky top-[190px] z-10 px-2 space-y-2">
                        <div class="relative group">
                            <input type="text" id="quick-add-input" placeholder="Adicionar item rápido..." 
                                oninput="handleQuickAddSearch(this.value)"
                                class="w-full px-4 py-3 rounded-xl bg-white border border-orange-200 shadow-sm focus:ring-2 focus:ring-orange-400 outline-none text-gray-700 placeholder-orange-300 transition-all">
                            <div class="absolute right-3 top-3 text-orange-400">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </div>
                            <div id="quick-add-dropdown" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-orange-100 hidden max-h-60 overflow-y-auto z-50"></div>
                        </div>
                        ${buttonHtml}
                    </div>
                 `;

                if (shoppingCart.size === 0) {
                    html += `
                        <div class="text-center py-12 flex flex-col items-center opacity-60">
                            <span class="text-gray-400 font-medium">Lista vazia</span>
                            <p class="text-xs text-gray-400 mt-1">Adicione itens acima ou pelo catálogo</p>
                        </div>`;
                }

                if (pendingItems.length > 0) {
                    html += `<div class="px-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">A Comprar</div>`;
                    html += pendingItems.map(item => renderCartItemRow(item, false)).join('');
                }

                if (doneItems.length > 0) {
                    html += `<div class="px-2 mt-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Comprados</div>`;
                    html += doneItems.map(item => renderCartItemRow(item, true)).join('');
                }

                list.innerHTML = html;
                return;
            }

            if (shoppingMode && shoppingSelectionMode) {
                // SELECTION VIEW
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center py-12 text-gray-400">Nenhum item encontrado.</div>`;
                    return;
                }
                list.innerHTML = filtered.map(item => {
                    const inCart = shoppingCart.has(item.id);
                    const qty = getItemQty(item);
                    const unit = item.unit || 'un';
                    const isZero = qty === 0;
                    const isLow = !isZero && item.minQty > 0 && qty <= item.minQty;
                    let statusBadge = "";
                    if (isZero) statusBadge = `<span class="bg-red-100 text-red-700 text-[10px] px-1.5 py-0.5 rounded font-bold ml-2">FALTA</span>`;
                    else if (isLow) statusBadge = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded font-bold ml-2">POUCO</span>`;

                    return `
                     <div class="bg-white p-3 rounded-xl mb-3 border-2 ${inCart ? 'border-orange-400 bg-orange-50' : 'border-transparent shadow-sm'} transition-all animate-fade-in" onclick="toggleCartItem(${item.id})">
                        <div class="flex items-center gap-3 cursor-pointer">
                            <div class="w-6 h-6 rounded border-2 ${inCart ? 'bg-orange-500 border-orange-500' : 'border-gray-300'} flex items-center justify-center text-white transition-colors">
                                ${inCart ? '✓' : ''}
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <span class="font-bold text-lg block ${inCart ? 'text-gray-800' : 'text-gray-700'}">${item.name}</span>
                                    ${statusBadge}
                                </div>
                                <span class="text-xs text-gray-500">Tem: ${qty} ${unit} • Min: ${item.minQty}</span>
                            </div>
                        </div>
                     </div>
                     `;
                }).join('');
                return;
            }

            // STANDARD RENDER
            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-12 text-gray-400">Nenhum item encontrado.</div>`;
                return;
            }
            list.innerHTML = filtered.map(item => {
                const qty = getItemQty(item);
                const isZero = qty === 0;
                const isLow = !isZero && item.minQty > 0 && qty <= item.minQty;
                const unit = item.unit || 'un';
                const expiry = getExpiryDate(item);
                let borderClass = 'border-gray-100';
                let alertBadge = '';

                if (isZero) {
                    borderClass = 'border-red-100 bg-red-50';
                    alertBadge = `<span class="bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded font-bold">FALTA</span>`;
                } else if (isLow) {
                    borderClass = 'border-yellow-200 bg-yellow-50';
                    alertBadge = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded font-bold">POUCO</span>`;
                }

                let expiryBadge = '';
                if (expiry && qty > 0) {
                    if (expiry < today) {
                        expiryBadge = `<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded font-bold ml-2">VENCEU</span>`;
                        if (!isZero && !isLow) borderClass = 'border-red-200 bg-red-50/30';
                    } else if (expiry < warningStr) {
                        expiryBadge = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded font-bold ml-2">VENCE LOGO</span>`;
                        if (!isZero && !isLow) borderClass = 'border-yellow-200 bg-yellow-50/30';
                    }
                }

                return `
                <div class="bg-white p-4 rounded-xl mb-3 card-shadow border ${borderClass} flex items-center justify-between transition-all animate-fade-in relative group">
                    <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                        <div class="flex flex-wrap items-center gap-y-1 mb-1">
                            <h3 class="font-bold text-gray-800 text-lg mr-2 ${isZero ? 'text-red-700' : ''}">${item.name}</h3>
                            ${alertBadge}
                            ${expiryBadge}
                        </div>
                        <div class="text-xs text-gray-400 flex flex-wrap gap-2 items-center">
                            <span class="bg-gray-100 px-2 py-0.5 rounded">${item.category}</span>
                            ${item.minQty > 0 ? `<span class="text-gray-300">Min: ${item.minQty}</span>` : ''}
                            ${expiry ? `<span>Val: ${expiry.split('-').reverse().join('/')}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 ml-2">
                        <div class="flex flex-col items-center justify-center min-w-[2.5rem]">
                            <span class="font-bold text-lg leading-none ${isZero ? 'text-red-600' : (isLow ? 'text-yellow-600' : 'text-emerald-700')}">${qty}</span>
                            <span class="text-[10px] text-gray-400 font-medium leading-none mt-0.5">${unit}</span>
                        </div>
                        <button onclick="checkInspectItem(${item.id})" class="ml-1 text-gray-400 hover:text-emerald-600 p-2 rounded-full hover:bg-emerald-50 transition" title="Gerenciar Unidades">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ items, categories }));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "backup_despensa.json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items) items = data.items;
                    if (data.categories) categories = data.categories;
                    save();
                    init();
                    showToast("Restaurado!");
                    toggleSettings();
                } catch (err) {
                    showToast("Erro no arquivo.");
                }
            };
            reader.readAsText(file);
        }

        function addCustomCategory() {
            const val = document.getElementById('new-cat-input').value.trim();
            if (val && !categories.includes(val)) {
                categories.push(val);
                save();
                renderCategories();
                renderCategorySelect();
                renderSettingsCategories();
                document.getElementById('new-cat-input').value = '';
                showToast("Categoria criada!");
            }
        }

        function deleteCategory(cat) {
            if (confirm(`Excluir categoria "${cat}"?`)) {
                categories = categories.filter(c => c !== cat);
                items.forEach(i => {
                    if (i.category === cat) i.category = 'Outros';
                });
                if (activeCategory === cat) activeCategory = 'Todos';
                save();
                renderCategories();
                renderCategorySelect();
                renderSettingsCategories();
                renderItems();
                showToast("Categoria excluída.");
            }
        }

        function renderSettingsCategories() {
            const list = document.getElementById('settings-cats-list');
            list.innerHTML = categories.map(c => `
                <div class="bg-gray-100 px-2 py-1 rounded flex items-center gap-1 text-xs text-gray-700">
                    <span>${c}</span>
                    ${c !== 'Outros' ? `
                    <button onclick="deleteCategory('${c}')" class="text-gray-400 hover:text-red-500 font-bold ml-1">×</button>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderCategories() {
            const container = document.getElementById('category-filters');
            const navCats = ['Todos', ...categories, 'Faltando'];
            container.innerHTML = navCats.map(c => `
                <button onclick="activeCategory='${c}'; renderCategories(); renderItems()" 
                class="px-4 py-1.5 rounded-full text-sm font-medium transition whitespace-nowrap border ${activeCategory === c ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">
                ${c}</button>
            `).join('');
        }

        function renderCategorySelect() {
            document.getElementById('item-category').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateSuggestions() {
            const uniqueNames = [...new Set(items.map(i => i.name))];
            document.getElementById('suggestions').innerHTML = uniqueNames.map(n => `<option value="${n}">`).join('');
        }

        function updateStats() {
            const missing = items.filter(i => getItemQty(i) === 0).length;
            const low = items.filter(i => {
                const q = getItemQty(i);
                return q > 0 && i.minQty > 0 && q <= i.minQty;
            }).length;
            document.getElementById('stats-display').innerText = `${items.length} itens • ${missing} faltas • ${low} pouco`;
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderSettingsCategories();
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        document.getElementById('item-modal').addEventListener('click', e => { if (e.target.id === 'item-modal') closeModal(); });
        document.getElementById('inspect-modal').addEventListener('click', e => { if (e.target.id === 'inspect-modal') closeInspectModal(); });

        init();

    </script>
</body>

</html>
